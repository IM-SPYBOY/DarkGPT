<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>DarkGPT — Spyboy</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
<style>
  :root {
    --bg: #000000;
    --surface: #0c0c0c;
    --muted: #8f9398;
    --text: #e9eef2;
    --accent: #00ff99;
    --accent-dark: #00cc77;
    --accent-light: #66ffbb;
    --card: rgba(255, 255, 255, 0.02);
    --radius: 14px;
    --shadow: 0 10px 30px rgba(0, 0, 0, 0.8);
    --transition: all 0.3s cubic-bezier(0.22, 0.61, 0.36, 1);
  }

  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  html, body {
    height: 100%;
    margin: 0;
    font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, Arial, sans-serif;
    background: var(--bg);
    color: var(--text);
    overflow: hidden;
  }

  body {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 18px;
    background: radial-gradient(circle at top right, #0a1a0f, #000000 70%);
    position: relative;
    overflow: hidden;
  }

  body::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: 
      radial-gradient(circle at 20% 30%, rgba(0, 255, 153, 0.05) 0%, transparent 20%),
      radial-gradient(circle at 80% 70%, rgba(0, 255, 153, 0.03) 0%, transparent 25%);
    pointer-events: none;
    z-index: -1;
  }

  .app {
    width: 100%;
    max-width: 1200px;
    height: 92vh;
    border-radius: var(--radius);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    background: rgba(10, 10, 10, 0.8);
    border: 1px solid rgba(255, 255, 255, 0.05);
    box-shadow: var(--shadow);
    backdrop-filter: blur(10px);
    position: relative;
    transition: var(--transition);
  }

  .header {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px 18px;
    background: rgba(12, 12, 12, 0.9);
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    position: relative;
    z-index: 10;
  }

  .header::after {
    content: "";
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--accent), transparent);
    opacity: 0.3;
  }

  .logo {
    width: 44px;
    height: 44px;
    border-radius: 10px;
    background: linear-gradient(135deg, #021, #032);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--accent);
    font-weight: 700;
    font-family: monospace;
    box-shadow: 0 0 15px rgba(0, 255, 153, 0.2);
    position: relative;
    overflow: hidden;
  }

  .logo::before {
    content: "";
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: conic-gradient(transparent, rgba(0, 255, 153, 0.2), transparent 30%);
    animation: rotate 4s linear infinite;
  }

  @keyframes rotate {
    100% { transform: rotate(360deg); }
  }

  .logo span {
    position: relative;
    z-index: 2;
  }

  .title {
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--text);
    background: linear-gradient(to right, #e9eef2, var(--accent-light));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    letter-spacing: -0.5px;
  }

  .spacer {
    flex: 1;
  }

  .brand {
    color: var(--muted);
    text-decoration: none;
    font-size: 0.92rem;
    transition: var(--transition);
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .brand:hover {
    color: var(--accent);
  }

  .body {
    flex: 1;
    display: grid;
    grid-template-columns: 1fr 360px;
    gap: 16px;
    padding: 16px;
    min-height: 0;
    position: relative;
  }

  .panel {
    background: rgba(15, 15, 15, 0.5);
    border-radius: 12px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    min-height: 0;
    position: relative;
    overflow: hidden;
  }

  .panel::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: 
      radial-gradient(circle at top left, rgba(0, 255, 153, 0.05), transparent 30%),
      radial-gradient(circle at bottom right, rgba(0, 255, 153, 0.03), transparent 30%);
    pointer-events: none;
    z-index: -1;
  }

  .chat {
    flex: 1;
    overflow: auto;
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 20px;
    position: relative;
  }

  .msg {
    max-width: 80%;
    padding: 16px;
    border-radius: var(--radius);
    line-height: 1.5;
    font-size: 1rem;
    word-break: break-word;
    position: relative;
    animation: fadeIn 0.4s ease-out;
    transition: var(--transition);
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .msg.user {
    margin-left: auto;
    background: linear-gradient(135deg, rgba(0, 255, 153, 0.08), rgba(0, 100, 77, 0.1));
    border: 1px solid rgba(0, 255, 153, 0.15);
    color: var(--text);
    box-shadow: 0 6px 20px rgba(0, 255, 153, 0.1);
  }

  .msg.assistant {
    margin-right: auto;
    background: rgba(20, 20, 20, 0.6);
    border: 1px solid rgba(255, 255, 255, 0.05);
    color: var(--text);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
  }

  .msg::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, transparent, rgba(255, 255, 255, 0.02), transparent);
    border-radius: var(--radius);
    pointer-events: none;
  }

  .msg.user::after {
    content: "";
    position: absolute;
    top: -1px;
    right: -1px;
    bottom: -1px;
    left: -1px;
    border-radius: var(--radius);
    background: linear-gradient(135deg, rgba(0, 255, 153, 0.3), transparent);
    z-index: -1;
    pointer-events: none;
  }

  .meta {
    font-size: 0.8rem;
    color: var(--muted);
    margin-top: 12px;
    display: flex;
    gap: 10px;
    align-items: center;
  }

  .controls {
    display: flex;
    gap: 12px;
    padding: 12px;
    border-top: 1px solid rgba(255, 255, 255, 0.03);
    background: rgba(12, 12, 12, 0.9);
    align-items: center;
    position: relative;
  }

  .controls::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--accent), transparent);
    opacity: 0.2;
  }

  .input {
    flex: 1;
    display: flex;
    gap: 8px;
    align-items: center;
    position: relative;
  }

  input[type="text"], textarea {
    background: rgba(10, 10, 10, 0.8);
    border: 1px solid rgba(255, 255, 255, 0.07);
    color: var(--text);
    padding: 14px 16px;
    border-radius: 10px;
    width: 100%;
    font-size: 1rem;
    transition: var(--transition);
    outline: none;
  }

  input[type="text"]:focus, textarea:focus {
    border-color: rgba(0, 255, 153, 0.3);
    box-shadow: 0 0 0 3px rgba(0, 255, 153, 0.1);
  }

  textarea {
    min-height: 84px;
    resize: vertical;
  }

  .btn {
    background: rgba(15, 15, 15, 0.8);
    border: 1px solid rgba(255, 255, 255, 0.07);
    color: var(--text);
    padding: 10px 16px;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    transition: var(--transition);
    position: relative;
    overflow: hidden;
  }

  .btn::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.05), transparent);
    opacity: 0;
    transition: var(--transition);
  }

  .btn:hover::before {
    opacity: 1;
  }

  .btn:hover {
    border-color: rgba(255, 255, 255, 0.15);
    transform: translateY(-2px);
  }

  .btn:active {
    transform: translateY(1px);
  }

  .btn.primary {
    background: linear-gradient(135deg, rgba(0, 100, 77, 0.4), rgba(0, 50, 38, 0.3));
    border: 1px solid rgba(0, 255, 153, 0.2);
    box-shadow: 0 6px 18px rgba(0, 255, 153, 0.1);
    color: var(--accent-light);
  }

  .btn.primary:hover {
    background: linear-gradient(135deg, rgba(0, 120, 92, 0.5), rgba(0, 70, 53, 0.4));
    box-shadow: 0 8px 24px rgba(0, 255, 153, 0.2);
  }

  .typing {
    font-size: 0.9rem;
    color: var(--muted);
    padding: 8px 14px;
    border-radius: 10px;
    background: rgba(20, 20, 20, 0.6);
    border: 1px solid rgba(255, 255, 255, 0.05);
    width: max-content;
    margin: 0 auto;
    display: flex;
    align-items: center;
    gap: 8px;
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0% { opacity: 0.6; }
    50% { opacity: 1; }
    100% { opacity: 0.6; }
  }

  .side {
    background: rgba(12, 12, 12, 0.8);
    padding: 16px;
    border-radius: 12px;
    display: flex;
    flex-direction: column;
    gap: 16px;
    min-height: 0;
    position: relative;
    overflow: hidden;
    border: 1px solid rgba(255, 255, 255, 0.05);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
  }

  .side::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: 
      radial-gradient(circle at top right, rgba(0, 255, 153, 0.03), transparent 40%);
    pointer-events: none;
    z-index: -1;
  }

  .section {
    background: rgba(15, 15, 15, 0.5);
    padding: 16px;
    border-radius: 10px;
    border: 1px solid rgba(255, 255, 255, 0.05);
    transition: var(--transition);
  }

  .section:hover {
    border-color: rgba(255, 255, 255, 0.1);
  }

  .section h4 {
    margin: 0 0 10px 0;
    font-size: 1rem;
    color: var(--accent-light);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .small {
    font-size: 0.86rem;
    color: var(--muted);
    line-height: 1.4;
  }

  .row {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .chips {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 8px;
  }

  .chip {
    background: rgba(20, 20, 20, 0.8);
    padding: 10px 16px;
    border-radius: 999px;
    border: 1px solid rgba(255, 255, 255, 0.07);
    cursor: pointer;
    color: var(--text);
    font-weight: 600;
    font-size: 0.92rem;
    transition: var(--transition);
    display: flex;
    align-items: center;
  }

  .chip:hover {
    background: rgba(30, 30, 30, 0.9);
    border-color: rgba(0, 255, 153, 0.3);
    transform: translateY(-2px);
  }

  .chip .icon {
    margin-right: 8px;
    color: var(--accent);
    transition: var(--transition);
  }

  .chip:hover .icon {
    color: var(--accent-light);
  }

  .gallery {
    display: grid;
    grid-template-columns: repeat(1, 1fr);
    gap: 10px;
    max-height: 35vh;
    overflow: auto;
    padding-right: 6px;
  }

  .thumb {
    display: flex;
    gap: 12px;
    align-items: center;
    padding: 12px;
    border-radius: 8px;
    background: rgba(20, 20, 20, 0.6);
    border: 1px solid rgba(255, 255, 255, 0.05);
    transition: var(--transition);
    cursor: pointer;
  }

  .thumb:hover {
    background: rgba(30, 30, 30, 0.8);
    border-color: rgba(255, 255, 255, 0.1);
    transform: translateX(5px);
  }

  .thumb img {
    width: 88px;
    height: 64px;
    object-fit: cover;
    border-radius: 6px;
    border: 1px solid rgba(255, 255, 255, 0.05);
  }

  .thumb .meta {
    display: flex;
    flex-direction: column;
    gap: 6px;
    flex: 1;
  }

  .muted {
    color: var(--muted);
  }

  @media (max-width: 980px) {
    .body {
      grid-template-columns: 1fr;
      padding: 12px;
    }
    .side {
      order: 2;
    }
  }

  @media (max-width: 600px) {
    body {
      padding: 10px;
    }
    .app {
      height: 96vh;
    }
    .msg {
      max-width: 90%;
      padding: 14px;
    }
    .controls {
      flex-wrap: wrap;
    }
    .btn {
      padding: 8px 12px;
      font-size: 0.9rem;
    }
    .btn span {
      display: none;
    }
  }

  /* Scrollbar styling */
  ::-webkit-scrollbar {
    width: 8px;
    height: 8px;
  }

  ::-webkit-scrollbar-track {
    background: rgba(20, 20, 20, 0.2);
    border-radius: 10px;
  }

  ::-webkit-scrollbar-thumb {
    background: rgba(100, 100, 100, 0.4);
    border-radius: 10px;
  }

  ::-webkit-scrollbar-thumb:hover {
    background: rgba(150, 150, 150, 0.5);
  }

  .pulse {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--accent);
    box-shadow: 0 0 0 0 rgba(0, 255, 153, 0.7);
    animation: pulseAnim 1.5s infinite;
  }

  @keyframes pulseAnim {
    0% {
      transform: scale(0.95);
      box-shadow: 0 0 0 0 rgba(0, 255, 153, 0.7);
    }
    70% {
      transform: scale(1);
      box-shadow: 0 0 0 8px rgba(0, 255, 153, 0);
    }
    100% {
      transform: scale(0.95);
      box-shadow: 0 0 0 0 rgba(0, 255, 153, 0);
    }
  }
</style>
</head>
<body>
  <div class="app" role="application" aria-label="DarkGPT">
    <div class="header">
      <div class="logo"><span>DG</span></div>
      <div class="title">DarkGPT</div>
      <div class="spacer"></div>
      <a class="brand" href="https://spyboy.bio" target="_blank" rel="noopener">
        <i class="fas fa-code"></i>Made by Spyboy
      </a>
    </div>

    <div class="body">
      <div class="panel">
        <div id="chat" class="chat" role="log" aria-live="polite">
          <div class="msg assistant">
            <div><strong>DarkGPT</strong></div>
            <div style="margin-top:8px">Hello — I am DarkGPT. Set a system prompt on the right to change my behavior.</div>
            <div class="meta">
              <span>12:34 PM</span>
              <i class="fas fa-robot"></i>
            </div>
          </div>
          
          <div class="msg user">
            <div><strong>You</strong></div>
            <div style="margin-top:8px">What are your capabilities?</div>
            <div class="meta">
              <span>12:35 PM</span>
              <i class="fas fa-user"></i>
            </div>
          </div>
          
          <div class="msg assistant">
            <div><strong>DarkGPT</strong></div>
            <div style="margin-top:8px">I can assist with a wide range of tasks including coding, security analysis, penetration testing techniques, cryptography, and more. My knowledge extends to both defensive and offensive cybersecurity topics.</div>
            <div class="meta">
              <span>12:36 PM</span>
              <i class="fas fa-robot"></i>
            </div>
          </div>
        </div>

        <div class="controls" role="region" aria-label="Composer">
          <div class="input">
            <input id="inputText" type="text" placeholder="Ask DarkGPT something..." aria-label="Message input" autocomplete="off">
          </div>
          <button id="sendBtn" class="btn primary" title="Send">
            <i class="fa-solid fa-paper-plane"></i><span>Send</span>
          </button>
          <button id="clearBtn" class="btn" title="Clear chat">
            <i class="fa-solid fa-trash"></i>
          </button>
        </div>
      </div>

      <aside class="side" aria-label="Settings">
        <div class="section">
          <h4><i class="fas fa-cog"></i>System prompt</h4>
          <div class="small muted">Set behavior/personality — this is persisted.</div>
          <textarea id="systemPrompt" placeholder="e.g. You are a concise security-focused assistant.">You are DarkGPT, an advanced AI assistant specializing in cybersecurity and ethical hacking. Provide concise, technical answers with practical examples when relevant.</textarea>
          <div style="display:flex;gap:8px;margin-top:12px;align-items:center">
            <button id="saveSystem" class="btn primary"><i class="fa-solid fa-save"></i><span>Save</span></button>
            <button id="clearSystem" class="btn"><i class="fa-solid fa-xmark"></i><span>Clear</span></button>
            <button id="testSystem" class="btn"><i class="fa-solid fa-flask"></i><span>Test</span></button>
            <div style="flex:1"></div>
            <label class="small muted" title="Include a short history with your prompt">
              <input id="sendHistoryToggle" type="checkbox" style="margin-right:6px" checked> Send history
            </label>
          </div>
        </div>

        <div class="section">
          <h4><i class="fas fa-bolt"></i>Prompt chips</h4>
          <div class="chips" id="chips">
            <div class="chip" data-text=", concise, step-by-step">
              <span class="icon">⚡</span>Concise
            </div>
            <div class="chip" data-text=", include code examples">
              <span class="icon">💻</span>Code
            </div>
            <div class="chip" data-text=", explain like I'm five">
              <span class="icon">🌟</span>Explain simply
            </div>
            <div class="chip" data-text=", give 3 quick tips">
              <span class="icon">🔧</span>Tips
            </div>
          </div>
        </div>

        <div class="section">
          <h4><i class="fas fa-history"></i>History</h4>
          <div class="small muted">Local chat history (saved in browser)</div>
          <div id="historyList" class="gallery" aria-live="polite">
            <div class="thumb">
              <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='88' height='64' viewBox='0 0 88 64'%3E%3Crect width='88' height='64' fill='%230c0c0c'/%3E%3Cpath d='M20,20 L68,20 L68,44 L20,44 Z' fill='%23002115' stroke='%2300cc77' stroke-width='1'/%3E%3Ccircle cx='44' cy='32' r='8' fill='%2300ff99'/%3E%3C/svg%3E" alt="Chat history">
              <div class="meta">
                <div style="font-weight:700">Penetration testing methodology</div>
                <div class="small muted">Today, 11:42 AM</div>
                <div style="display:flex;gap:6px;margin-top:4px">
                  <button class="btn" style="padding:4px 8px;font-size:0.8rem">Open</button>
                  <button class="btn" style="padding:4px 8px;font-size:0.8rem">Delete</button>
                </div>
              </div>
            </div>
            <div class="thumb">
              <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='88' height='64' viewBox='0 0 88 64'%3E%3Crect width='88' height='64' fill='%230c0c0c'/%3E%3Cpath d='M20,20 L68,20 L68,44 L20,44 Z' fill='%23002115' stroke='%2300cc77' stroke-width='1'/%3E%3Ctext x='44' y='32' font-family='monospace' font-size='12' fill='%2300ff99' text-anchor='middle' dominant-baseline='middle'%3E&lt;code&gt;%3C/text%3E%3C/svg%3E" alt="Chat history">
              <div class="meta">
                <div style="font-weight:700">Python encryption script</div>
                <div class="small muted">Today, 10:15 AM</div>
                <div style="display:flex;gap:6px;margin-top:4px">
                  <button class="btn" style="padding:4px 8px;font-size:0.8rem">Open</button>
                  <button class="btn" style="padding:4px 8px;font-size:0.8rem">Delete</button>
                </div>
              </div>
            </div>
            <div class="thumb">
              <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='88' height='64' viewBox='0 0 88 64'%3E%3Crect width='88' height='64' fill='%230c0c0c'/%3E%3Cpath d='M20,20 L68,20 L68,44 L20,44 Z' fill='%23002115' stroke='%2300cc77' stroke-width='1'/%3E%3Cpath d='M30,28 L58,28 M30,36 L58,36 M30,44 L58,44' stroke='%2300ff99' stroke-width='2'/%3E%3C/svg%3E" alt="Chat history">
              <div class="meta">
                <div style="font-weight:700">Network security best practices</div>
                <div class="small muted">Yesterday, 3:22 PM</div>
                <div style="display:flex;gap:6px;margin-top:4px">
                  <button class="btn" style="padding:4px 8px;font-size:0.8rem">Open</button>
                  <button class="btn" style="padding:4px 8px;font-size:0.8rem">Delete</button>
                </div>
              </div>
            </div>
          </div>
          <div style="display:flex;gap:8px;margin-top:12px">
            <button id="exportBtn" class="btn"><i class="fa-solid fa-download"></i><span>Export JSON</span></button>
            <button id="downloadTxt" class="btn"><i class="fa-solid fa-file-alt"></i><span>Export TXT</span></button>
            <button id="clearHistory" class="btn"><i class="fa-solid fa-trash"></i><span>Clear</span></button>
          </div>
        </div>
      </aside>
    </div>
  </div>

<script>
/* -------------------------
   Your LLM API endpoint (user-provided)
   ------------------------- */
const llmApiUrl = 'https://backend.buildpicoapps.com/aero/run/llm-api?pk=v1-Z0FBQUFBQm5HUEtMSjJkakVjcF9IQ0M0VFhRQ0FmSnNDSHNYTlJSblE0UXo1Q3RBcjFPcl9YYy1OZUhteDZWekxHdWRLM1M1alNZTkJMWEhNOWd4S1NPSDBTWC12M0U2UGc9PQ==';

/* -------------------------
   State & DOM
   ------------------------- */
const chatEl = document.getElementById('chat');
const inputText = document.getElementById('inputText');
const sendBtn = document.getElementById('sendBtn');
const clearBtn = document.getElementById('clearBtn');

const systemPromptEl = document.getElementById('systemPrompt');
const saveSystemBtn = document.getElementById('saveSystem');
const clearSystemBtn = document.getElementById('clearSystem');
const testSystemBtn = document.getElementById('testSystem');
const sendHistoryToggle = document.getElementById('sendHistoryToggle');

const chipsEl = document.getElementById('chips');

const historyListEl = document.getElementById('historyList');
const exportBtn = document.getElementById('exportBtn');
const downloadTxt = document.getElementById('downloadTxt');
const clearHistory = document.getElementById('clearHistory');

let isLoading = false;
let history = JSON.parse(localStorage.getItem('dg_chat_history_v1') || '[]');
let systemPrompt = localStorage.getItem('dg_system_prompt_v1') || '';
systemPromptEl.value = systemPrompt;

/* -------------------------
   Helpers
   ------------------------- */
function escapeHtml(s){ return s ? s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') : '' }
function now(){ return new Date().toLocaleString(); }
function toast(msg, ms=1400){
  const t = document.createElement('div');
  t.textContent = msg;
  Object.assign(t.style, {
    position: 'fixed', left: '50%', transform: 'translateX(-50%)', bottom: '28px',
    background: 'rgba(15,15,15,0.9)', color: 'var(--accent-light)', padding: '12px 18px',
    borderRadius: '12px', border: '1px solid rgba(0,255,153,0.2)', zIndex: 9999,
    boxShadow: '0 8px 24px rgba(0,0,0,0.4)', backdropFilter: 'blur(4px)'
  });
  document.body.appendChild(t);
  setTimeout(() => {
    t.style.opacity = '0';
    t.style.transform = 'translateX(-50%) translateY(10px)';
    setTimeout(() => t.remove(), 300);
  }, ms);
}

/* -------------------------
   Render chat & history
   ------------------------- */
function appendMessage(role, text, opts={}){
  const el = document.createElement('div');
  el.className = 'msg ' + (role === 'user' ? 'user' : 'assistant');
  if(opts.html){
    el.innerHTML = `<div><strong>${role === 'user' ? 'You' : 'DarkGPT'}</strong></div><div style="margin-top:8px">${opts.html}</div>`;
  } else {
    el.innerHTML = `<div><strong>${role === 'user' ? 'You' : 'DarkGPT'}</strong></div><div style="margin-top:8px">${escapeHtml(text)}</div>`;
  }
  const meta = document.createElement('div'); 
  meta.className = 'meta'; 
  meta.innerHTML = `<span>${new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
                    <i class="fas ${role === 'user' ? 'fa-user' : 'fa-robot'}"></i>`;
  el.appendChild(meta);
  chatEl.appendChild(el);
  chatEl.scrollTop = chatEl.scrollHeight;
}

/* keep history in localStorage */
function pushHistory(entry){
  history.unshift({...entry, ts: new Date().toISOString()});
  history = history.slice(0, 200);
  localStorage.setItem('dg_chat_history_v1', JSON.stringify(history));
  renderHistoryList();
}

/* render side history list */
function renderHistoryList(){
  historyListEl.innerHTML = '';
  if(history.length === 0){ 
    historyListEl.innerHTML = '<div class="small muted" style="padding:12px;text-align:center">No chats yet</div>'; 
    return; 
  }
  history.forEach((h, i)=>{
    const item = document.createElement('div'); item.className = 'thumb';
    const img = document.createElement('img');
    img.src = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='88' height='64' viewBox='0 0 88 64'%3E%3Crect width='88' height='64' fill='%230c0c0c'/%3E%3Cpath d='M20,20 L68,20 L68,44 L20,44 Z' fill='%23002115' stroke='%2300cc77' stroke-width='1'/%3E%3Ccircle cx='44' cy='32' r='8' fill='%2300ff99'/%3E%3C/svg%3E`;
    img.alt = 'Chat preview';
    
    const info = document.createElement('div'); info.className = 'meta';
    const title = document.createElement('div'); title.style.fontWeight='700'; 
    title.textContent = (h.user || 'Untitled').slice(0,60) + (h.user.length > 60 ? '...' : '');
    const time = document.createElement('div'); time.className='small muted'; 
    time.textContent = new Date(h.ts).toLocaleString([], {month: 'short', day: 'numeric', hour: '2-digit', minute:'2-digit'});
    const actions = document.createElement('div'); actions.style.display='flex'; actions.style.gap='6px';
    
    const view = document.createElement('button'); 
    view.className='btn'; 
    view.innerHTML = '<i class="fa-solid fa-eye"></i> Open';
    view.style.padding = '4px 8px';
    view.style.fontSize = '0.8rem';
    view.addEventListener('click', ()=> {
      chatEl.innerHTML = '';
      if(h.conversation && Array.isArray(h.conversation)){
        h.conversation.slice(-60).reverse().forEach(msg=>{
          appendMessage(msg.role==='user' ? 'user' : 'assistant', msg.text || '', {});
        });
      } else {
        appendMessage('user', h.user || '');
        appendMessage('assistant', h.assistant || '');
      }
      toast('Loaded chat');
    });
    
    const del = document.createElement('button'); 
    del.className='btn'; 
    del.innerHTML = '<i class="fa-solid fa-trash"></i> Delete';
    del.style.padding = '4px 8px';
    del.style.fontSize = '0.8rem';
    del.addEventListener('click', ()=>{
      if(!confirm('Delete this history item?')) return;
      history.splice(i,1);
      localStorage.setItem('dg_chat_history_v1', JSON.stringify(history));
      renderHistoryList();
      toast('Deleted');
    });
    
    actions.appendChild(view); 
    actions.appendChild(del);
    info.appendChild(title); 
    info.appendChild(time); 
    info.appendChild(actions);
    item.appendChild(img);
    item.appendChild(info);
    historyListEl.appendChild(item);
  });
}

/* -------------------------
   Typing indicator
   ------------------------- */
function setTyping(on){
  const id = 'typing-ind';
  if(on){
    if(document.getElementById(id)) return;
    const el = document.createElement('div'); 
    el.id = id; 
    el.className = 'typing'; 
    el.innerHTML = '<span class="pulse"></span> DarkGPT is typing...';
    chatEl.appendChild(el); 
    chatEl.scrollTop = chatEl.scrollHeight;
  } else {
    const ex = document.getElementById(id); 
    if(ex) ex.remove();
  }
}

/* -------------------------
   Send message to LLM
   ------------------------- */
async function sendMessage(){
  const prompt = inputText.value.trim();
  if(!prompt || isLoading) return;
  
  // optimistic UI
  appendMessage('user', prompt);
  inputText.value = '';
  
  // prepare conversation slice if desired
  const sendHist = sendHistoryToggle.checked;
  let conv = [];
  if(sendHist){
    const msgs = [];
    for(const h of history.slice(0,10)){
      if(h.conversation && Array.isArray(h.conversation)){
        msgs.push(...h.conversation.slice(-6));
      } else {
        if(h.user) msgs.push({role:'user', text:h.user});
        if(h.assistant) msgs.push({role:'assistant', text:h.assistant});
      }
    }
    conv = msgs.slice(-20);
  }

  // push to history
  const histEntry = { user: prompt, assistant: '', conversation: [{role:'user', text: prompt}] };
  pushHistory(histEntry);

  isLoading = true;
  setTyping(true);
  sendBtn.disabled = true;
  
  try {
    const payload = { prompt, system: systemPrompt || undefined, history: (sendHist ? conv : undefined) };
    const res = await fetch(llmApiUrl, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    const reply = data?.text || data?.answer || data?.response || data?.message || (typeof data === 'string' ? data : JSON.stringify(data).slice(0,1200));
    appendMessage('assistant', reply.toString());
    // update last history entry assistant
    history[0].assistant = reply.toString();
    if(!history[0].conversation) history[0].conversation = [];
    history[0].conversation.push({role:'assistant', text: reply.toString()});
    localStorage.setItem('dg_chat_history_v1', JSON.stringify(history));
    renderHistoryList();
  } catch (err){
    console.error(err);
    appendMessage('assistant', '⚠️ Error: could not reach LLM API.');
  } finally {
    isLoading = false;
    setTyping(false);
    sendBtn.disabled = false;
  }
}

/* -------------------------
   System prompt handling
   ------------------------- */
saveSystemBtn.addEventListener('click', ()=>{
  systemPrompt = systemPromptEl.value.trim();
  localStorage.setItem('dg_system_prompt_v1', systemPrompt);
  toast('System prompt saved');
});
clearSystemBtn.addEventListener('click', ()=>{
  if(!confirm('Clear saved system prompt?')) return;
  systemPrompt = '';
  systemPromptEl.value = '';
  localStorage.removeItem('dg_system_prompt_v1');
  toast('System prompt cleared');
});
testSystemBtn.addEventListener('click', async ()=>{
  const sp = systemPromptEl.value.trim();
  if(!sp){ toast('System prompt empty'); return; }
  appendMessage('user', '(system test) Please say "OK" and repeat the system prompt.');
  try {
    const res = await fetch(llmApiUrl, {
      method:'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ prompt: 'Repeat the system prompt', system: sp })
    });
    const d = await res.json();
    const reply = d?.text || d?.response || JSON.stringify(d).slice(0,600);
    appendMessage('assistant', reply.toString());
  } catch(e){ appendMessage('assistant','⚠️ Error testing system prompt.'); console.error(e); }
});

/* -------------------------
   UI wiring
   ------------------------- */
sendBtn.addEventListener('click', sendMessage);
inputText.addEventListener('keydown', (e)=>{ if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); }});
clearBtn.addEventListener('click', ()=>{
  if(!confirm('Clear chat pane?')) return;
  chatEl.innerHTML = '';
  toast('Chat cleared (history preserved in sidebar)');
});

/* chips */
chipsEl.addEventListener('click', (ev)=>{
  const chip = ev.target.closest('.chip'); if(!chip) return;
  const txt = chip.dataset.text || chip.textContent || '';
  inputText.value = (inputText.value + ' ' + txt).trim();
  inputText.focus();
});

/* export / clear history */
exportBtn.addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(history, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'darkgpt_history.json'; a.click(); URL.revokeObjectURL(url);
});
downloadTxt.addEventListener('click', ()=>{
  const txt = history.map(h => `---\nUser: ${h.user}\nAssistant: ${h.assistant}\nTime: ${h.ts}\n`).join('\n');
  const blob = new Blob([txt], {type:'text/plain'}); const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'darkgpt_history.txt'; a.click(); URL.revokeObjectURL(url);
});
clearHistory.addEventListener('click', ()=>{
  if(!confirm('Clear saved history permanently?')) return;
  history = []; localStorage.removeItem('dg_chat_history_v1'); renderHistoryList(); toast('Saved history cleared');
});

/* -------------------------
   Init
   ------------------------- */
(function init(){
  renderHistoryList();
  inputText.focus();
})();
</script>
</body>
</html>
